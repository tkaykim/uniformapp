<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>유니폼 운영 시스템 - CRUD</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // supabase 변수명 중복 방지: window.supabase로 접근
    const sb = window.supabase.createClient(
      'https://pebyrncdfrbgwhgkagtk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlYnlybmNkZnJiZ3doZ2thZ3RrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc0NzM1NzMsImV4cCI6MjA2MzA0OTU3M30.C_OW_XKunWMulydwOs-Tb5xEU2rxYPLFfubIJsh39Ew'
    );

    // 탭 전환
    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(el => el.style.display = 'none');
      document.getElementById(tab).style.display = 'block';
      if(tab==='orderTab') loadOrders();
      if(tab==='purchaseTab') loadPurchases();
      if(tab==='designTab') loadDesigns();
    }

    // 주문 CRUD
    async function createOrder() {
      const orderId = generateOrderId();
      const { data, error } = await sb.from('evOrder').insert([{
        orderId,
        orderDate: document.getElementById('orderDate').value,
        groupName: document.getElementById('groupName').value,
        managerName: document.getElementById('managerName').value,
        managerPhone: document.getElementById('managerPhone').value,
        totalPrice: parseInt(document.getElementById('totalPrice').value) || 0,
        orderStatus: '주문접수'
      }]);
      if (error) alert('주문 등록 실패: ' + error.message);
      else {
        alert('주문 등록 성공');
        loadOrders();
      }
    }
    function generateOrderId() {
      const d = new Date();
      return d.getFullYear().toString() + 
        String(d.getMonth()+1).padStart(2,'0') + 
        String(d.getDate()).padStart(2,'0') + 
        Math.floor(Math.random()*10000).toString().padStart(4,'0');
    }
    async function loadOrders() {
      const { data, error } = await sb.from('evOrder').select('*').order('createdAt', { ascending: false });
      const tbody = document.getElementById('orderList');
      tbody.innerHTML = '';
      if (error) {
        tbody.innerHTML = '<tr><td colspan="10">불러오기 실패: '+error.message+'</td></tr>';
        return;
      }
      // 주문 row HTML을 먼저 누적
      let html = '';
      data.forEach(o => {
        html += `
          <tr>
            <td>${o.orderId}
              <button onclick="expandAll('${o.orderId}')" style="font-size:11px;">모두 펼치기</button>
              <button onclick="collapseAll('${o.orderId}')" style="font-size:11px;">모두 접기</button>
            </td>
            <td>${o.groupName}</td>
            <td>${o.managerName}</td>
            <td>${o.managerPhone}</td>
            <td>${o.totalPrice}</td>
            <td>
              <button onclick="showPurchaseForm('${o.orderId}')">발주</button>
              <button onclick="togglePurchaseList('${o.orderId}')">발주목록</button>
              <span id="purchaseStatus-${o.orderId}">-</span>
            </td>
            <td>
              <button onclick="showDesignForm('${o.orderId}')">디자인</button>
              <button onclick="toggleDesignList('${o.orderId}')">디자인목록</button>
              <span id="designStatus-${o.orderId}">-</span>
            </td>
            <td>
              <button onclick="showPrintForm('${o.orderId}')">인쇄</button>
              <button onclick="togglePrintList('${o.orderId}')">인쇄목록</button>
              <span id="printStatus-${o.orderId}">-</span>
            </td>
            <td>
              <button onclick="showDeliveryForm('${o.orderId}')">배송</button>
              <button onclick="toggleDeliveryList('${o.orderId}')">배송목록</button>
              <span id="deliveryStatus-${o.orderId}">-</span>
            </td>
            <td>
              <button onclick="editOrderPrompt('${o.orderId}')">수정</button>
              <button onclick="deleteOrder('${o.orderId}')">삭제</button>
            </td>
                  </tr>
          <tr id="purchase-form-row-${o.orderId}" style="display:none;">
            <td colspan="10"><div id="purchaseFormDiv-${o.orderId}"></div></td>
                  </tr>
          <tr id="purchase-list-row-${o.orderId}" style="display:none;">
            <td colspan="10"><div id="purchaseListDiv-${o.orderId}"></div></td>
                  </tr>
          <tr id="design-form-row-${o.orderId}" style="display:none;">
            <td colspan="10"><div id="designFormDiv-${o.orderId}"></div></td>
                  </tr>
          <tr id="design-list-row-${o.orderId}" style="display:none;">
            <td colspan="10"><div id="designListDiv-${o.orderId}"></div></td>
          </tr>
          <tr id="print-form-row-${o.orderId}" style="display:none;">
            <td colspan="10"><div id="printFormDiv-${o.orderId}"></div></td>
          </tr>
          <tr id="print-list-row-${o.orderId}" style="display:none;">
            <td colspan="10"><div id="printListDiv-${o.orderId}"></div></td>
          </tr>
          <tr id="delivery-form-row-${o.orderId}" style="display:none;">
            <td colspan="10"><div id="deliveryFormDiv-${o.orderId}"></div></td>
          </tr>
          <tr id="delivery-list-row-${o.orderId}" style="display:none;">
            <td colspan="10"><div id="deliveryListDiv-${o.orderId}"></div></td>
          </tr>
        `;
      });
      tbody.innerHTML = html;
      // 모든 주문에 대해 collapseAll을 한 번 더 호출 (실제 DOM에 반영된 후)
      data.forEach(o => {
        collapseAll(o.orderId);
        // 각 파트별 상태 업데이트
        updatePurchaseStatus(o.orderId);
        updateDesignStatus(o.orderId);
        updatePrintStatus(o.orderId);
        updateDeliveryStatus(o.orderId);
      });
    }
    async function deleteOrder(orderId) {
      if (!confirm('정말 삭제?')) return;
      const { error } = await sb.from('evOrder').delete().eq('orderId', orderId);
      if (error) alert('삭제 실패: ' + error.message);
      else loadOrders();
    }
    async function editOrderPrompt(orderId) {
      const newName = prompt('새 단체명 입력');
      if (!newName) return;
      const { error } = await sb.from('evOrder').update({ groupName: newName }).eq('orderId', orderId);
      if (error) alert('수정 실패: ' + error.message);
      else loadOrders();
    }

    // 발주 CRUD
    async function createPurchase() {
      const purchaseId = generatePurchaseId();
      const { data, error } = await sb.from('evPurchase').insert([{
        purchaseId,
        orderId: document.getElementById('purchaseOrderId').value,
        groupName: document.getElementById('purchaseGroupName').value,
        itemName: document.getElementById('itemName').value,
        itemCode: document.getElementById('itemCode').value,
        color: document.getElementById('color').value,
        managerName: document.getElementById('purchaseManagerName').value,
        totalQuantity: parseInt(document.getElementById('purchaseTotalQuantity').value) || 0,
        purchaseStatus: '발주전'
      }]);
      if (error) alert('발주 등록 실패: ' + error.message);
      else {
        alert('발주 등록 성공');
        loadPurchases();
      }
    }
    function generatePurchaseId() {
      const d = new Date();
      return d.getFullYear().toString() + 
        String(d.getMonth()+1).padStart(2,'0') + 
        String(d.getDate()).padStart(2,'0') + 
        '_PUR' + Math.floor(Math.random()*1000).toString().padStart(3,'0');
    }
    async function loadPurchases() {
      const { data, error } = await sb.from('evPurchase').select('*').order('createdAt', { ascending: false });
      const tbody = document.getElementById('purchaseList');
      tbody.innerHTML = '';
      if (error) {
        tbody.innerHTML = '<tr><td colspan="6">불러오기 실패: '+error.message+'</td></tr>';
        return;
      }
      data.forEach(p => {
        tbody.innerHTML += `
          <tr>
            <td>${p.purchaseId}</td>
            <td>${p.orderId}</td>
            <td>${p.groupName}</td>
            <td>${p.itemName}</td>
            <td>${p.totalQuantity}</td>
            <td>
              <button onclick="editPurchasePrompt('${p.purchaseId}')">수정</button>
              <button onclick="deletePurchase('${p.purchaseId}')">삭제</button>
            </td>
          </tr>
        `;
      });
    }
    async function deletePurchase(purchaseId) {
      if (!confirm('정말 삭제?')) return;
      const { error } = await sb.from('evPurchase').delete().eq('purchaseId', purchaseId);
      if (error) alert('삭제 실패: ' + error.message);
      else loadPurchases();
    }
    async function editPurchasePrompt(purchaseId) {
      const newName = prompt('새 제품명 입력');
      if (!newName) return;
      const { error } = await sb.from('evPurchase').update({ itemName: newName }).eq('purchaseId', purchaseId);
      if (error) alert('수정 실패: ' + error.message);
      else loadPurchases();
    }

    // 디자인 CRUD
    async function createDesign() {
      const designId = generateDesignId();
      const { data, error } = await sb.from('evDesign').insert([{
        designId,
        orderId: document.getElementById('designOrderId').value,
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        driveLink: document.getElementById('driveLink').value,
        createdBy: document.getElementById('createdBy').value,
        designStatus: '착수전'
      }]);
      if (error) alert('디자인 등록 실패: ' + error.message);
      else {
        alert('디자인 등록 성공');
      loadDesigns();
    }
    }
    function generateDesignId() {
      const d = new Date();
      return d.getFullYear().toString() + 
        String(d.getMonth()+1).padStart(2,'0') + 
        String(d.getDate()).padStart(2,'0') + 
        '_DES' + Math.floor(Math.random()*1000).toString().padStart(3,'0');
    }
    async function loadDesigns() {
      const { data, error } = await sb.from('evDesign').select('*').order('createdAt', { ascending: false });
      const tbody = document.getElementById('designList');
      tbody.innerHTML = '';
      if (error) {
        tbody.innerHTML = '<tr><td colspan="6">불러오기 실패: '+error.message+'</td></tr>';
        return;
      }
      data.forEach(d => {
        tbody.innerHTML += `
          <tr>
            <td>${d.designId}</td>
            <td>${d.orderId}</td>
            <td>${d.title}</td>
            <td>${d.createdBy}</td>
            <td>
              <button onclick="editDesignPrompt('${d.designId}')">수정</button>
              <button onclick="deleteDesign('${d.designId}')">삭제</button>
            </td>
          </tr>
        `;
      });
    }
    async function deleteDesign(designId) {
      if (!confirm('정말 삭제?')) return;
      const { error } = await sb.from('evDesign').delete().eq('designId', designId);
      if (error) alert('삭제 실패: ' + error.message);
      else loadDesigns();
    }
    async function editDesignPrompt(designId) {
      const newTitle = prompt('새 디자인 제목 입력');
      if (!newTitle) return;
      const { error } = await sb.from('evDesign').update({ title: newTitle }).eq('designId', designId);
      if (error) alert('수정 실패: ' + error.message);
      else loadDesigns();
    }

    // 발주 폼/목록
    function showPurchaseForm(orderId) {
      document.querySelectorAll('[id^=purchase-form-row-]').forEach(row => row.style.display = 'none');
      const row = document.getElementById('purchase-form-row-' + orderId);
      row.style.display = '';
      const div = document.getElementById('purchaseFormDiv-' + orderId);
      const sizes = [
        "size_110","size_120","size_130","size_140","size_150","size_160",
        "size_XS","size_SS","size_S","size_M","size_L","size_XL",
        "size_2XL","size_3XL","size_4XL","size_5XL","size_LL",
        "size_3L","size_4L","size_5L","size_free","size_custom"
      ];
      let sizeInputs = '';
      sizes.forEach(k => {
        sizeInputs += `
          <div style="display:inline-block;margin:5px;">
            <label>${k.replace('size_','').toUpperCase()}</label>
            <input id="${k}-${orderId}" type="number" value="0" style="width:50px;" 
                   onchange="updateTotalQuantity('${orderId}')" min="0">
          </div>`;
      });
      div.innerHTML = `
        <b>발주 등록 (주문번호: ${orderId})</b><br>
        <input id="itemName-${orderId}" placeholder="제품명">
        <input id="itemCode-${orderId}" placeholder="제품코드">
        <input id="color-${orderId}" placeholder="색상">
        <input id="managerName-${orderId}" placeholder="담당자명">
        <input id="totalQuantity-${orderId}" placeholder="총수량" readonly style="background-color:#f0f0f0"><br>
        <div>${sizeInputs}</div>
        <button onclick="createPurchase('${orderId}')">발주 등록</button>
      `;
    }
    async function createPurchase(orderId) {
      const purchaseId = generatePurchaseId();
      const sizes = [
        "size_110","size_120","size_130","size_140","size_150","size_160",
        "size_XS","size_SS","size_S","size_M","size_L","size_XL",
        "size_2XL","size_3XL","size_4XL","size_5XL","size_LL",
        "size_3L","size_4L","size_5L","size_free","size_custom"
      ];
      const sizeData = {};
      sizes.forEach(k => {
        sizeData[k] = parseInt(document.getElementById(`${k}-${orderId}`).value) || 0;
      });
      const totalQuantity = sizes.reduce((sum, k) => sum + (sizeData[k] || 0), 0);
      const { error } = await sb.from('evPurchase').insert([{
        purchaseId,
        orderId,
        groupName: '',
        itemName: document.getElementById('itemName-' + orderId).value,
        itemCode: document.getElementById('itemCode-' + orderId).value,
        color: document.getElementById('color-' + orderId).value,
        managerName: document.getElementById('managerName-' + orderId).value,
        ...sizeData,
        totalQuantity,
        purchaseStatus: '발주전'
      }]);
      if (error) alert('발주 등록 실패: ' + error.message);
      else {
        alert('발주 등록 성공');
        togglePurchaseList(orderId, true);
      }
    }
    async function togglePurchaseList(orderId, forceOpen) {
      const row = document.getElementById('purchase-list-row-' + orderId);
      if (forceOpen) row.style.display = '';
      else row.style.display = row.style.display === 'none' ? '' : 'none';
      if (row.style.display !== 'none') {
        const { data, error } = await sb.from('evPurchase')
          .select('*')
          .eq('orderId', orderId)
          .order('createdAt', { ascending: false });
        const div = document.getElementById('purchaseListDiv-' + orderId);
        if (error) {
          div.innerHTML = '불러오기 실패: ' + error.message;
          return;
        }
        if (!data.length) {
          div.innerHTML = '등록된 발주가 없습니다.';
          return;
        }

        const sizes = [
          "size_110","size_120","size_130","size_140","size_150","size_160",
          "size_XS","size_SS","size_S","size_M","size_L","size_XL",
          "size_2XL","size_3XL","size_4XL","size_5XL","size_LL",
          "size_3L","size_4L","size_5L","size_free","size_custom"
        ];

        const sizeHeaders = sizes.map(k => `<th>${k.replace('size_','').toUpperCase()}</th>`).join('');

        div.innerHTML = `
          <b>발주 목록</b><br>
          <table border="1">
            <tr>
              <th>발주번호</th>
              <th>제품명</th>
              <th>제품코드</th>
              <th>색상</th>
              <th>담당자</th>
              <th>총수량</th>
              <th>상태</th>
              ${sizeHeaders}
              <th>관리</th>
            </tr>
            ${data.map(p => `
              <tr id="purchase-row-${p.purchaseId}">
                <td>${p.purchaseId}</td>
                <td><span class="editable" data-field="itemName">${p.itemName}</span></td>
                <td><span class="editable" data-field="itemCode">${p.itemCode}</span></td>
                <td><span class="editable" data-field="color">${p.color}</span></td>
                <td><span class="editable" data-field="managerName">${p.managerName}</span></td>
                <td><span class="total-quantity">${p.totalQuantity}</span></td>
                <td>
                  <select onchange="updatePurchaseStatus('${orderId}', '${p.purchaseId}', this.value)" 
                          style="color: ${getStatusColor(p.purchaseStatus)}">
                    <option value="발주전" ${p.purchaseStatus === '발주전' ? 'selected' : ''}>발주전</option>
                    <option value="진행중" ${p.purchaseStatus === '진행중' ? 'selected' : ''}>진행중</option>
                    <option value="완료" ${p.purchaseStatus === '완료' ? 'selected' : ''}>완료</option>
              </select>
            </td>
                ${sizes.map(k => `<td><span class="editable" data-field="${k}">${p[k] || 0}</span></td>`).join('')}
                <td>
                  <button onclick="togglePurchaseEdit('${p.purchaseId}', '${orderId}')" id="edit-btn-${p.purchaseId}">수정</button>
                  <button onclick="savePurchaseEdit('${p.purchaseId}', '${orderId}')" style="display:none" id="save-btn-${p.purchaseId}">저장</button>
                  <button onclick="deletePurchase('${p.purchaseId}','${orderId}')">삭제</button>
            </td>
          </tr>
            `).join('')}
          </table>
        `;
      }
    }
    async function deletePurchase(purchaseId, orderId) {
      if (!confirm('정말 삭제?')) return;
      const { error } = await sb.from('evPurchase').delete().eq('purchaseId', purchaseId);
      if (error) alert('삭제 실패: ' + error.message);
      else togglePurchaseList(orderId, true);
    }
    async function editPurchasePrompt(purchaseId, orderId) {
      const newName = prompt('새 제품명 입력');
      if (!newName) return;
      const { error } = await sb.from('evPurchase').update({ itemName: newName }).eq('purchaseId', purchaseId);
      if (error) alert('수정 실패: ' + error.message);
      else togglePurchaseList(orderId, true);
    }

    // 인쇄 폼/목록
    function showPrintForm(orderId) {
      document.querySelectorAll('[id^=print-form-row-]').forEach(row => row.style.display = 'none');
      const row = document.getElementById('print-form-row-' + orderId);
      row.style.display = '';
      const div = document.getElementById('printFormDiv-' + orderId);
      div.innerHTML = `
        <b>인쇄 등록 (주문번호: ${orderId})</b><br>
        <input id="printMethod-${orderId}" placeholder="인쇄방식">
        <input id="factoryName-${orderId}" placeholder="인쇄소명">
        <input id="factoryContact-${orderId}" placeholder="인쇄소 연락처">
        <input id="deliveryAddress-${orderId}" placeholder="납품주소">
        <input id="expectedDate-${orderId}" type="date" placeholder="납기일">
        <button onclick="createPrint('${orderId}')">인쇄 등록</button>
      `;
    }
    async function createPrint(orderId) {
      const printId = generatePrintId();
      const { error } = await sb.from('evPrint').insert([{
        printId,
        orderId,
        printMethod: document.getElementById('printMethod-' + orderId).value,
        factoryName: document.getElementById('factoryName-' + orderId).value,
        factoryContact: document.getElementById('factoryContact-' + orderId).value,
        deliveryAddress: document.getElementById('deliveryAddress-' + orderId).value,
        expectedDate: document.getElementById('expectedDate-' + orderId).value,
        printStatus: '발주전'
      }]);
      if (error) alert('인쇄 등록 실패: ' + error.message);
      else {
        alert('인쇄 등록 성공');
        togglePrintList(orderId, true);
      }
    }
    function generatePrintId() {
      const d = new Date();
      return d.getFullYear().toString() + 
        String(d.getMonth()+1).padStart(2,'0') + 
        String(d.getDate()).padStart(2,'0') + 
        '_PRT' + Math.floor(Math.random()*1000).toString().padStart(3,'0');
    }
    async function togglePrintList(orderId, forceOpen) {
      const row = document.getElementById('print-list-row-' + orderId);
      if (forceOpen) row.style.display = '';
      else row.style.display = row.style.display === 'none' ? '' : 'none';
      if (row.style.display !== 'none') {
        const { data, error } = await sb.from('evPrint')
          .select('*')
          .eq('orderId', orderId)
          .order('createdAt', { ascending: false });
        const div = document.getElementById('printListDiv-' + orderId);
        if (error) {
          div.innerHTML = '불러오기 실패: ' + error.message;
          return;
        }
        if (!data.length) {
          div.innerHTML = '등록된 인쇄가 없습니다.';
          return;
        }
        div.innerHTML = `
          <b>인쇄 목록</b><br>
          <table border="1">
            <tr>
              <th>인쇄번호</th>
              <th>인쇄방식</th>
              <th>인쇄소명</th>
              <th>인쇄소 연락처</th>
              <th>납품주소</th>
              <th>납기일</th>
              <th>상태</th>
              <th>관리</th>
            </tr>
            ${data.map(p => `
              <tr id="print-row-${p.printId}">
                <td>${p.printId}</td>
                <td><span class="editable" data-field="printMethod">${p.printMethod}</span></td>
                <td><span class="editable" data-field="factoryName">${p.factoryName}</span></td>
                <td><span class="editable" data-field="factoryContact">${p.factoryContact}</span></td>
                <td><span class="editable" data-field="deliveryAddress">${p.deliveryAddress}</span></td>
                <td><span class="editable" data-field="expectedDate">${p.expectedDate || ''}</span></td>
                <td>
                  <select onchange="updatePrintStatus('${orderId}', '${p.printId}', this.value)"
                          style="color: ${getStatusColor(p.printStatus)}">
                    <option value="발주전" ${p.printStatus === '발주전' ? 'selected' : ''}>발주전</option>
                    <option value="진행중" ${p.printStatus === '진행중' ? 'selected' : ''}>진행중</option>
                    <option value="완료" ${p.printStatus === '완료' ? 'selected' : ''}>완료</option>
                  </select>
                </td>
                <td>
                  <button onclick="togglePrintEdit('${p.printId}', '${orderId}')" id="edit-btn-${p.printId}">수정</button>
                  <button onclick="savePrintEdit('${p.printId}', '${orderId}')" style="display:none" id="save-btn-${p.printId}">저장</button>
                  <button onclick="deletePrint('${p.printId}','${orderId}')">삭제</button>
            </td>
          </tr>
            `).join('')}
          </table>
        `;
      }
    }
    async function deletePrint(printId, orderId) {
      if (!confirm('정말 삭제?')) return;
      const { error } = await sb.from('evPrint').delete().eq('printId', printId);
      if (error) alert('삭제 실패: ' + error.message);
      else togglePrintList(orderId, true);
    }
    async function editPrintPrompt(printId, orderId) {
      const newMethod = prompt('새 인쇄방식 입력');
      if (!newMethod) return;
      const { error } = await sb.from('evPrint').update({ printMethod: newMethod }).eq('printId', printId);
      if (error) alert('수정 실패: ' + error.message);
      else togglePrintList(orderId, true);
    }

    // 배송 폼/목록
    function showDeliveryForm(orderId) {
      document.querySelectorAll('[id^=delivery-form-row-]').forEach(row => row.style.display = 'none');
      const row = document.getElementById('delivery-form-row-' + orderId);
      row.style.display = '';
      const div = document.getElementById('deliveryFormDiv-' + orderId);
      div.innerHTML = `
        <b>배송 등록 (주문번호: ${orderId})</b><br>
        <input id="courierName-${orderId}" placeholder="택배사">
        <input id="trackingNumber-${orderId}" placeholder="송장번호">
        <button onclick="createDelivery('${orderId}')">배송 등록</button>
      `;
    }
    async function createDelivery(orderId) {
      const deliveryId = generateDeliveryId();
      const { error } = await sb.from('evDelivery').insert([{
        deliveryId,
        orderId,
        courierName: document.getElementById('courierName-' + orderId).value,
        trackingNumber: document.getElementById('trackingNumber-' + orderId).value,
        deliveryStatus: '배송전'
      }]);
      if (error) alert('배송 등록 실패: ' + error.message);
      else {
        alert('배송 등록 성공');
        toggleDeliveryList(orderId, true);
      }
    }
    function generateDeliveryId() {
      const d = new Date();
      return d.getFullYear().toString() + 
        String(d.getMonth()+1).padStart(2,'0') + 
        String(d.getDate()).padStart(2,'0') + 
        '_DLV' + Math.floor(Math.random()*1000).toString().padStart(3,'0');
    }
    async function toggleDeliveryList(orderId, forceOpen) {
      const row = document.getElementById('delivery-list-row-' + orderId);
      if (forceOpen) row.style.display = '';
      else row.style.display = row.style.display === 'none' ? '' : 'none';
      if (row.style.display !== 'none') {
        const { data, error } = await sb.from('evDelivery')
          .select('*')
          .eq('orderId', orderId)
          .order('createdAt', { ascending: false });
        const div = document.getElementById('deliveryListDiv-' + orderId);
        if (error) {
          div.innerHTML = '불러오기 실패: ' + error.message;
        return;
      }
        if (!data.length) {
          div.innerHTML = '등록된 배송이 없습니다.';
          return;
        }
        div.innerHTML = `
          <b>배송 목록</b><br>
          <table border="1">
            <tr>
              <th>배송번호</th>
              <th>택배사</th>
              <th>송장번호</th>
              <th>배송주소</th>
              <th>수령인</th>
              <th>연락처</th>
              <th>상태</th>
              <th>관리</th>
            </tr>
            ${data.map(d => `
              <tr id="delivery-row-${d.deliveryId}">
                <td>${d.deliveryId}</td>
                <td><span class="editable" data-field="courierName">${d.courierName}</span></td>
                <td><span class="editable" data-field="trackingNumber">${d.trackingNumber}</span></td>
                <td><span class="editable" data-field="deliveryAddress">${d.deliveryAddress}</span></td>
                <td><span class="editable" data-field="recipientName">${d.recipientName}</span></td>
                <td><span class="editable" data-field="recipientPhone">${d.recipientPhone}</span></td>
                <td>
                  <select onchange="updateDeliveryStatus('${orderId}', '${d.deliveryId}', this.value)"
                          style="color: ${getStatusColor(d.deliveryStatus)}">
                    <option value="배송전" ${d.deliveryStatus === '배송전' ? 'selected' : ''}>배송전</option>
                    <option value="진행중" ${d.deliveryStatus === '진행중' ? 'selected' : ''}>진행중</option>
                    <option value="완료" ${d.deliveryStatus === '완료' ? 'selected' : ''}>완료</option>
              </select>
            </td>
                <td>
                  <button onclick="toggleDeliveryEdit('${d.deliveryId}', '${orderId}')" id="edit-btn-${d.deliveryId}">수정</button>
                  <button onclick="saveDeliveryEdit('${d.deliveryId}', '${orderId}')" style="display:none" id="save-btn-${d.deliveryId}">저장</button>
                  <button onclick="deleteDelivery('${d.deliveryId}','${orderId}')">삭제</button>
            </td>
          </tr>
            `).join('')}
          </table>
        `;
      }
    }
    async function deleteDelivery(deliveryId, orderId) {
      if (!confirm('정말 삭제?')) return;
      const { error } = await sb.from('evDelivery').delete().eq('deliveryId', deliveryId);
      if (error) alert('삭제 실패: ' + error.message);
      else toggleDeliveryList(orderId, true);
    }
    async function editDeliveryPrompt(deliveryId, orderId) {
      const newCourier = prompt('새 택배사 입력');
      if (!newCourier) return;
      const { error } = await sb.from('evDelivery').update({ courierName: newCourier }).eq('deliveryId', deliveryId);
      if (error) alert('수정 실패: ' + error.message);
      else toggleDeliveryList(orderId, true);
    }

    // 디자인 폼/목록
    function showDesignForm(orderId) {
      document.querySelectorAll('[id^=design-form-row-]').forEach(row => row.style.display = 'none');
      const row = document.getElementById('design-form-row-' + orderId);
      row.style.display = '';
      const div = document.getElementById('designFormDiv-' + orderId);
      div.innerHTML = `
        <b>디자인 등록 (주문번호: ${orderId})</b><br>
        <input id="title-${orderId}" placeholder="디자인 제목">
        <input id="description-${orderId}" placeholder="설명">
        <input id="driveLink-${orderId}" placeholder="구글드라이브 링크">
        <input id="createdBy-${orderId}" placeholder="작성자">
        <button onclick="createDesign('${orderId}')">디자인 등록</button>
      `;
    }
    async function createDesign(orderId) {
      const designId = generateDesignId();
      const { error } = await sb.from('evDesign').insert([{
        designId,
        orderId,
        title: document.getElementById('title-' + orderId).value,
        description: document.getElementById('description-' + orderId).value,
        driveLink: document.getElementById('driveLink-' + orderId).value,
        createdBy: document.getElementById('createdBy-' + orderId).value,
        designStatus: '착수전'
      }]);
      if (error) alert('디자인 등록 실패: ' + error.message);
      else {
        alert('디자인 등록 성공');
        toggleDesignList(orderId, true);
      }
    }
    async function toggleDesignList(orderId, forceOpen) {
      const row = document.getElementById('design-list-row-' + orderId);
      if (forceOpen) row.style.display = '';
      else row.style.display = row.style.display === 'none' ? '' : 'none';
      if (row.style.display !== 'none') {
        const { data, error } = await sb.from('evDesign')
          .select('*')
          .eq('orderId', orderId)
          .order('createdAt', { ascending: false });
        const div = document.getElementById('designListDiv-' + orderId);
        if (error) {
          div.innerHTML = '불러오기 실패: ' + error.message;
        return;
      }
        if (!data.length) {
          div.innerHTML = '등록된 디자인이 없습니다.';
          return;
        }
        div.innerHTML = `
          <b>디자인 목록</b><br>
          <table border="1">
            <tr>
              <th>디자인번호</th>
              <th>제목</th>
              <th>설명</th>
              <th>구글드라이브 링크</th>
              <th>작성자</th>
              <th>상태</th>
              <th>관리</th>
            </tr>
            ${data.map(d => `
              <tr id="design-row-${d.designId}">
                <td>${d.designId}</td>
                <td><span class="editable" data-field="title">${d.title}</span></td>
                <td><span class="editable" data-field="description">${d.description}</span></td>
                <td><span class="editable" data-field="driveLink">${d.driveLink}</span></td>
                <td><span class="editable" data-field="createdBy">${d.createdBy}</span></td>
                <td>
                  <select onchange="updateDesignStatus('${orderId}', '${d.designId}', this.value)"
                          style="color: ${getStatusColor(d.designStatus)}">
                    <option value="착수전" ${d.designStatus === '착수전' ? 'selected' : ''}>착수전</option>
                    <option value="진행중" ${d.designStatus === '진행중' ? 'selected' : ''}>진행중</option>
                    <option value="완료" ${d.designStatus === '완료' ? 'selected' : ''}>완료</option>
              </select>
            </td>
                <td>
                  <button onclick="toggleDesignEdit('${d.designId}', '${orderId}')" id="edit-btn-${d.designId}">수정</button>
                  <button onclick="saveDesignEdit('${d.designId}', '${orderId}')" style="display:none" id="save-btn-${d.designId}">저장</button>
                  <button onclick="deleteDesign('${d.designId}','${orderId}')">삭제</button>
            </td>
          </tr>
            `).join('')}
          </table>
        `;
      }
    }
    async function deleteDesign(designId, orderId) {
      if (!confirm('정말 삭제?')) return;
      const { error } = await sb.from('evDesign').delete().eq('designId', designId);
      if (error) alert('삭제 실패: ' + error.message);
      else toggleDesignList(orderId, true);
    }
    async function editDesignPrompt(designId, orderId) {
      const newTitle = prompt('새 디자인 제목 입력');
      if (!newTitle) return;
      const { error } = await sb.from('evDesign').update({ title: newTitle }).eq('designId', designId);
      if (error) alert('수정 실패: ' + error.message);
      else toggleDesignList(orderId, true);
    }

    // 상태 업데이트 함수들 (목록 펼치지 않고 상태 span만 업데이트)
    async function updatePurchaseStatus(orderId) {
      // 가장 최근 발주 상태만 표시
      const { data, error } = await sb.from('evPurchase')
        .select('purchaseStatus')
        .eq('orderId', orderId)
        .order('createdAt', { ascending: false });
      const statusSpan = document.getElementById('purchaseStatus-' + orderId);
      if (error || !data || data.length === 0) {
        statusSpan.textContent = '-';
        statusSpan.style.color = 'gray';
        return;
      }
      statusSpan.textContent = data[0].purchaseStatus;
      statusSpan.style.color = getStatusColor(data[0].purchaseStatus);
    }
    async function updateDesignStatus(orderId) {
      const { data, error } = await sb.from('evDesign')
        .select('designStatus')
        .eq('orderId', orderId)
        .order('createdAt', { ascending: false });
      const statusSpan = document.getElementById('designStatus-' + orderId);
      if (error || !data || data.length === 0) {
        statusSpan.textContent = '-';
        statusSpan.style.color = 'gray';
        return;
      }
      statusSpan.textContent = data[0].designStatus;
      statusSpan.style.color = getStatusColor(data[0].designStatus);
    }
    async function updatePrintStatus(orderId) {
      const { data, error } = await sb.from('evPrint')
        .select('printStatus')
        .eq('orderId', orderId)
        .order('createdAt', { ascending: false });
      const statusSpan = document.getElementById('printStatus-' + orderId);
      if (error || !data || data.length === 0) {
        statusSpan.textContent = '-';
        statusSpan.style.color = 'gray';
        return;
      }
      statusSpan.textContent = data[0].printStatus;
      statusSpan.style.color = getStatusColor(data[0].printStatus);
    }
    async function updateDeliveryStatus(orderId) {
      const { data, error } = await sb.from('evDelivery')
        .select('deliveryStatus')
        .eq('orderId', orderId)
        .order('createdAt', { ascending: false });
      const statusSpan = document.getElementById('deliveryStatus-' + orderId);
      if (error || !data || data.length === 0) {
        statusSpan.textContent = '-';
        statusSpan.style.color = 'gray';
        return;
      }
      statusSpan.textContent = data[0].deliveryStatus;
      statusSpan.style.color = getStatusColor(data[0].deliveryStatus);
    }

    function getStatusColor(status) {
      switch(status) {
        case '발주전':
        case '착수전':
        case '배송전':
          return 'red';
        case '진행중':
          return 'orange';
        case '완료':
          return 'green';
        default:
          return 'black';
      }
    }

    // 총 수량 자동 계산 함수
    function updateTotalQuantity(orderId) {
      const sizes = [
        "size_110","size_120","size_130","size_140","size_150","size_160",
        "size_XS","size_SS","size_S","size_M","size_L","size_XL",
        "size_2XL","size_3XL","size_4XL","size_5XL","size_LL",
        "size_3L","size_4L","size_5L","size_free","size_custom"
      ];
      let total = 0;
      sizes.forEach(k => {
        const value = parseInt(document.getElementById(`${k}-${orderId}`).value) || 0;
        total += value;
      });
      document.getElementById('totalQuantity-' + orderId).value = total;
    }

    // 발주 수정 모드 토글
    function togglePurchaseEdit(purchaseId, orderId) {
      const row = document.getElementById('purchase-row-' + purchaseId);
      const editableSpans = row.querySelectorAll('.editable');
      const editBtn = document.getElementById('edit-btn-' + purchaseId);
      const saveBtn = document.getElementById('save-btn-' + purchaseId);
      
      editableSpans.forEach(span => {
        const currentValue = span.textContent;
        const field = span.getAttribute('data-field');
        if (field.startsWith('size_')) {
          // 사이즈별 수량 필드
          span.innerHTML = `<input type="number" value="${currentValue}" 
                                 id="edit-${field}-${purchaseId}" 
                                 onchange="updateEditTotalQuantity('${purchaseId}')" 
                                 min="0" style="width:50px">`;
        } else {
          // 일반 텍스트 필드
          span.innerHTML = `<input type="text" value="${currentValue}" 
                                 id="edit-${field}-${purchaseId}" 
                                 style="width:100%">`;
        }
      });

      editBtn.style.display = 'none';
      saveBtn.style.display = 'inline';
    }

    // 수정 중인 발주의 총 수량 업데이트
    function updateEditTotalQuantity(purchaseId) {
      const sizes = [
        "size_110","size_120","size_130","size_140","size_150","size_160",
        "size_XS","size_SS","size_S","size_M","size_L","size_XL",
        "size_2XL","size_3XL","size_4XL","size_5XL","size_LL",
        "size_3L","size_4L","size_5L","size_free","size_custom"
      ];
      let total = 0;
      sizes.forEach(k => {
        const value = parseInt(document.getElementById(`edit-${k}-${purchaseId}`).value) || 0;
        total += value;
      });
      const row = document.getElementById('purchase-row-' + purchaseId);
      row.querySelector('.total-quantity').textContent = total;
    }

    // 발주 수정 저장
    async function savePurchaseEdit(purchaseId, orderId) {
      const sizes = [
        "size_110","size_120","size_130","size_140","size_150","size_160",
        "size_XS","size_SS","size_S","size_M","size_L","size_XL",
        "size_2XL","size_3XL","size_4XL","size_5XL","size_LL",
        "size_3L","size_4L","size_5L","size_free","size_custom"
      ];

      const updateData = {
        itemName: document.getElementById('edit-itemName-' + purchaseId).value,
        itemCode: document.getElementById('edit-itemCode-' + purchaseId).value,
        color: document.getElementById('edit-color-' + purchaseId).value,
        managerName: document.getElementById('edit-managerName-' + purchaseId).value
      };

      // 사이즈별 수량 추가
      sizes.forEach(k => {
        updateData[k] = parseInt(document.getElementById(`edit-${k}-${purchaseId}`).value) || 0;
      });

      // 총 수량 계산
      updateData.totalQuantity = sizes.reduce((sum, k) => sum + (updateData[k] || 0), 0);

      const { error } = await sb.from('evPurchase')
        .update(updateData)
        .eq('purchaseId', purchaseId);

      if (error) {
        alert('수정 실패: ' + error.message);
        return;
      }

      alert('수정 완료');
      togglePurchaseList(orderId, true);
    }

    // 디자인 수정 모드 토글
    function toggleDesignEdit(designId, orderId) {
      const row = document.getElementById('design-row-' + designId);
      const editableSpans = row.querySelectorAll('.editable');
      const editBtn = document.getElementById('edit-btn-' + designId);
      const saveBtn = document.getElementById('save-btn-' + designId);
      
      editableSpans.forEach(span => {
        const currentValue = span.textContent;
        const field = span.getAttribute('data-field');
        span.innerHTML = `<input type="text" value="${currentValue}" 
                               id="edit-${field}-${designId}" 
                               style="width:100%">`;
      });

      editBtn.style.display = 'none';
      saveBtn.style.display = 'inline';
    }

    // 인쇄 수정 모드 토글
    function togglePrintEdit(printId, orderId) {
      const row = document.getElementById('print-row-' + printId);
      const editableSpans = row.querySelectorAll('.editable');
      const editBtn = document.getElementById('edit-btn-' + printId);
      const saveBtn = document.getElementById('save-btn-' + printId);
      
      editableSpans.forEach(span => {
        const currentValue = span.textContent;
        const field = span.getAttribute('data-field');
        if (field === 'expectedDate') {
          span.innerHTML = `<input type="date" value="${currentValue}" 
                                 id="edit-${field}-${printId}" 
                                 style="width:100%">`;
        } else {
          span.innerHTML = `<input type="text" value="${currentValue}" 
                                 id="edit-${field}-${printId}" 
                                 style="width:100%">`;
        }
      });

      editBtn.style.display = 'none';
      saveBtn.style.display = 'inline';
    }

    // 배송 수정 모드 토글
    function toggleDeliveryEdit(deliveryId, orderId) {
      const row = document.getElementById('delivery-row-' + deliveryId);
      const editableSpans = row.querySelectorAll('.editable');
      const editBtn = document.getElementById('edit-btn-' + deliveryId);
      const saveBtn = document.getElementById('save-btn-' + deliveryId);
      
      editableSpans.forEach(span => {
        const currentValue = span.textContent;
        const field = span.getAttribute('data-field');
        span.innerHTML = `<input type="text" value="${currentValue}" 
                               id="edit-${field}-${deliveryId}" 
                               style="width:100%">`;
      });

      editBtn.style.display = 'none';
      saveBtn.style.display = 'inline';
    }

    // 디자인 수정 저장
    async function saveDesignEdit(designId, orderId) {
      const updateData = {
        title: document.getElementById('edit-title-' + designId).value,
        description: document.getElementById('edit-description-' + designId).value,
        driveLink: document.getElementById('edit-driveLink-' + designId).value,
        createdBy: document.getElementById('edit-createdBy-' + designId).value
      };

      const { error } = await sb.from('evDesign')
        .update(updateData)
        .eq('designId', designId);

      if (error) {
        alert('수정 실패: ' + error.message);
        return;
      }
      
      alert('수정 완료');
      toggleDesignList(orderId, true);
    }

    // 인쇄 수정 저장
    async function savePrintEdit(printId, orderId) {
      const updateData = {
        printMethod: document.getElementById('edit-printMethod-' + printId).value,
        factoryName: document.getElementById('edit-factoryName-' + printId).value,
        factoryContact: document.getElementById('edit-factoryContact-' + printId).value,
        deliveryAddress: document.getElementById('edit-deliveryAddress-' + printId).value,
        expectedDate: document.getElementById('edit-expectedDate-' + printId).value
      };

      const { error } = await sb.from('evPrint')
        .update(updateData)
        .eq('printId', printId);

      if (error) {
        alert('수정 실패: ' + error.message);
        return;
      }

      alert('수정 완료');
      togglePrintList(orderId, true);
    }

    // 배송 수정 저장
    async function saveDeliveryEdit(deliveryId, orderId) {
      const updateData = {
        courierName: document.getElementById('edit-courierName-' + deliveryId).value,
        trackingNumber: document.getElementById('edit-trackingNumber-' + deliveryId).value,
        deliveryAddress: document.getElementById('edit-deliveryAddress-' + deliveryId).value,
        recipientName: document.getElementById('edit-recipientName-' + deliveryId).value,
        recipientPhone: document.getElementById('edit-recipientPhone-' + deliveryId).value
      };

      const { error } = await sb.from('evDelivery')
        .update(updateData)
        .eq('deliveryId', deliveryId);

      if (error) {
        alert('수정 실패: ' + error.message);
        return;
      }

      alert('수정 완료');
      toggleDeliveryList(orderId, true);
    }

    // 모두 펼치기/접기 함수 추가
    function expandAll(orderId) {
      document.getElementById('purchase-list-row-' + orderId).style.display = '';
      document.getElementById('design-list-row-' + orderId).style.display = '';
      document.getElementById('print-list-row-' + orderId).style.display = '';
      document.getElementById('delivery-list-row-' + orderId).style.display = '';
      // 목록 새로고침
      togglePurchaseList(orderId, true);
      toggleDesignList(orderId, true);
      togglePrintList(orderId, true);
      toggleDeliveryList(orderId, true);
    }
    function collapseAll(orderId) {
      document.getElementById('purchase-list-row-' + orderId).style.display = 'none';
      document.getElementById('design-list-row-' + orderId).style.display = 'none';
      document.getElementById('print-list-row-' + orderId).style.display = 'none';
      document.getElementById('delivery-list-row-' + orderId).style.display = 'none';
    }

    // 발주 상태 변경 (select에서 호출)
    async function updatePurchaseStatus(orderId, purchaseId, newStatus) {
      const { error } = await sb.from('evPurchase')
        .update({ purchaseStatus: newStatus })
        .eq('purchaseId', purchaseId);
      if (error) {
        alert('상태 변경 실패: ' + error.message);
        return;
      }
      // 상태 span 즉시 갱신
      await updatePurchaseStatus(orderId);
    }
    // 디자인 상태 변경 (select에서 호출)
    async function updateDesignStatus(orderId, designId, newStatus) {
      const { error } = await sb.from('evDesign')
        .update({ designStatus: newStatus })
        .eq('designId', designId);
      if (error) {
        alert('상태 변경 실패: ' + error.message);
        return;
      }
      await updateDesignStatus(orderId);
    }
    // 인쇄 상태 변경 (select에서 호출)
    async function updatePrintStatus(orderId, printId, newStatus) {
      const { error } = await sb.from('evPrint')
        .update({ printStatus: newStatus })
        .eq('printId', printId);
      if (error) {
        alert('상태 변경 실패: ' + error.message);
        return;
      }
      await updatePrintStatus(orderId);
    }
    // 배송 상태 변경 (select에서 호출)
    async function updateDeliveryStatus(orderId, deliveryId, newStatus) {
      const { error } = await sb.from('evDelivery')
        .update({ deliveryStatus: newStatus })
        .eq('deliveryId', deliveryId);
      if (error) {
        alert('상태 변경 실패: ' + error.message);
        return;
      }
      await updateDeliveryStatus(orderId);
    }

    window.onload = () => showTab('orderTab');
  </script>
</head>
<body>
  <button onclick="showTab('orderTab')">주문관리</button>
  <button onclick="showTab('purchaseTab')">발주관리</button>
  <button onclick="showTab('designTab')">디자인관리</button>

  <!-- 주문관리 -->
  <div id="orderTab" class="tab" style="display:none;">
    <h2>주문 등록</h2>
    <input id="orderDate" type="date" value="2024-05-20">
    <input id="groupName" placeholder="단체명">
    <input id="managerName" placeholder="담당자명">
    <input id="managerPhone" placeholder="담당자연락처">
    <input id="totalPrice" placeholder="총금액">
    <button onclick="createOrder()">등록</button>
    <h3>주문 목록</h3>
    <table border="1"><thead>
      <tr>
        <th>주문번호</th><th>단체명</th><th>담당자</th><th>연락처</th><th>총금액</th>
        <th>발주</th><th>디자인</th><th>인쇄</th><th>배송</th><th>관리</th>
      </tr>
    </thead><tbody id="orderList"></tbody></table>
  </div>

  <!-- 발주관리 -->
  <div id="purchaseTab" class="tab" style="display:none;">
    <h2>발주 등록</h2>
    <input id="purchaseOrderId" placeholder="주문번호">
    <input id="purchaseGroupName" placeholder="단체명">
    <input id="itemName" placeholder="제품명">
    <input id="itemCode" placeholder="제품코드">
    <input id="color" placeholder="색상">
    <input id="purchaseManagerName" placeholder="담당자명">
    <input id="purchaseTotalQuantity" placeholder="총수량">
    <button onclick="createPurchase()">등록</button>
    <h3>발주 목록</h3>
    <table border="1"><thead>
      <tr><th>발주번호</th><th>주문번호</th><th>단체명</th><th>제품명</th><th>총수량</th><th>관리</th></tr>
    </thead><tbody id="purchaseList"></tbody></table>
  </div>

  <!-- 디자인관리 -->
  <div id="designTab" class="tab" style="display:none;">
    <h2>디자인 등록</h2>
    <input id="designOrderId" placeholder="주문번호">
    <input id="title" placeholder="디자인 제목">
    <input id="description" placeholder="설명">
    <input id="driveLink" placeholder="구글드라이브 링크">
    <input id="createdBy" placeholder="작성자">
    <button onclick="createDesign()">등록</button>
    <h3>디자인 목록</h3>
    <table border="1"><thead>
      <tr><th>디자인번호</th><th>주문번호</th><th>제목</th><th>작성자</th><th>관리</th></tr>
    </thead><tbody id="designList"></tbody></table>
  </div>
</body>
</html>
